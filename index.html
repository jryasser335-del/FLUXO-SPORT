<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//fonts.gstatic.com">
<link rel="preconnect" href="https://image.tmdb.org" crossorigin>
<link rel="dns-prefetch" href="//image.tmdb.org">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
<title>FLUXO | Sports & Movies</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
  --bg:#000000;
  --bg2:#000000;
  --panel: rgba(255,255,255,.05);
  --panel2: rgba(255,255,255,.08);
  --stroke: rgba(255,255,255,.10);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.60);

  /* Paleta m√°s "negro" (sin morados/rojos) */
  --accent:#2a2a2f;
  --accent2:#141418;

  --good:#2ee59d;
  --danger:#ff2d55;

  --radius:18px;
  --radius2:26px;
  --shadow: 0 22px 80px rgba(0,0,0,.85);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
html,body{height:100%}
body{
  color:var(--text);
  /* Fondo negro s√≥lido (m√°s "cine") */
  background:#000;
  overflow-x:hidden;
}

/* ===== INTRO (GRATIS) ===== */
#intro{
  position:fixed; inset:0; z-index:9999;
  display:flex; align-items:center; justify-content:center;
  /* Intro en negro s√≥lido */
  background:#000;
  cursor:pointer;
}
#intro.hide{
  opacity:0;
  transform:scale(1.02);
  pointer-events:none;
  transition:opacity .7s ease, transform .7s ease;
}
.introCard{
  width:min(980px,92vw);
  border-radius:30px;
  border:1px solid rgba(255,255,255,.12);
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow: 0 40px 140px rgba(0,0,0,.9);
  overflow:hidden;
  position:relative;
}
.introGlow{
  position:absolute; inset:-140px;
  background: conic-gradient(from 210deg,
    rgba(255,255,255,0),
    rgba(255,255,255,.20),
    rgba(255,255,255,.10),
    rgba(255,255,255,0));
  filter: blur(48px);
  opacity:.58;
  animation: spin 3.2s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.introInner{
  position:relative;
  padding:28px;
  display:flex;
  gap:18px;
  align-items:center;
}
@media (max-width: 700px){
  .introInner{flex-direction:column; text-align:center}
}
.introOrb{
  width:76px;height:76px;border-radius:24px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 55%),
              linear-gradient(135deg, rgba(255,255,255,.28), rgba(255,255,255,.10));
  border:1px solid rgba(255,255,255,.16);
  box-shadow: 0 20px 70px rgba(255,255,255,.08);
  flex:0 0 auto;
}
.introText b{
  font-family:Oswald;
  letter-spacing:.8px;
  font-size:28px;
}
.introText p{
  margin-top:6px;
  color:rgba(255,255,255,.72);
  line-height:1.45;
  font-size:13.5px;
}
.introBar{
  margin-top:14px;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.35);
  overflow:hidden;
}
.introBar > i{
  display:block;
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(255,255,255,.60), rgba(255,255,255,.20));
  box-shadow:0 0 26px rgba(255,255,255,.10);
  animation: loadbar 1.8s ease forwards;
}
@keyframes loadbar{to{width:100%}}
.introHint{
  margin-top:10px;
  color:rgba(255,255,255,.55);
  font-size:12px;
}

/* ===== Skeletons ===== */
.skel{
  position:relative;
  overflow:hidden;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.08);
}
.skel::after{
  content:"";
  position:absolute; inset:0;
  transform:translateX(-120%);
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer{
  100%{transform:translateX(120%)}
}
.card.skel{min-height:320px}
.eventCard.skel{height:190px}
.channelCard.skel{height:74px}


/* ===== APP LAYOUT ===== */
.app{
  display:grid;
  grid-template-columns: 86px 1fr;
  min-height:100vh;
}
.sidebar{
  position:sticky; top:0; height:100vh;
  padding:16px 12px;
  display:flex; flex-direction:column; align-items:center; gap:12px;
  border-right:1px solid rgba(255,255,255,.06);
  background: rgba(255,255,255,.02);
  backdrop-filter: blur(10px);
}
.logoMini{
  width:56px;height:56px;border-radius:18px;
  display:flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg, rgba(124,58,237,.65), rgba(255,45,85,.40));
  border:1px solid rgba(255,255,255,.14);
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
}
.logoMini span{font-family:Oswald; font-size:18px; letter-spacing:.6px}
.navBtn{
  width:58px;height:58px;border-radius:18px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:6px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  cursor:pointer;
  transition: transform .15s ease, border-color .2s ease, background .2s ease;
}
.navBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.18)}
.navBtn.active{
  background: linear-gradient(180deg, rgba(124,58,237,.22), rgba(255,255,255,.03));
  border-color: rgba(124,58,237,.40);
}
.navBtn i{
  width:18px;height:18px; display:block;
  background: rgba(255,255,255,.88);
  mask-size:contain; mask-repeat:no-repeat; mask-position:center;
  -webkit-mask-size:contain; -webkit-mask-repeat:no-repeat; -webkit-mask-position:center;
}
.navBtn small{font-size:10px; color:var(--muted); letter-spacing:.4px}

.main{padding:18px 18px 28px}
.topbar{
  display:flex; align-items:center; justify-content:space-between;
  gap:14px;
  padding:10px 12px;
  border-radius: 20px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.50);
  backdrop-filter: blur(10px);
}
.topLeft{display:flex; align-items:center; gap:12px}
.brandLine{display:flex; flex-direction:column; line-height:1.05}
.brandLine b{font-family:Oswald; letter-spacing:.7px}
.brandLine small{color:var(--muted); font-size:12px}
.searchWrap{
  flex:1;
  display:flex; align-items:center; gap:10px;
  max-width:720px;
}
.search{
  flex:1;
  height:40px;
  padding:0 14px;
  border-radius: 999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  color:var(--text);
  outline:none;
}
.pillTop{
  height:40px;
  padding:0 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color:var(--text);
  cursor:pointer;
  display:inline-flex; align-items:center; gap:10px;
}
.pillTop:hover{border-color:rgba(255,255,255,.18)}
.pillTop .dot{
  width:10px;height:10px;border-radius:999px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow:0 0 18px rgba(124,58,237,.35);
}

.section{
  margin-top:16px;
  padding:16px;
  border-radius: 22px;
  border:1px solid rgba(255,255,255,.07);
  background: rgba(255,255,255,.03);
  box-shadow: var(--shadow);
}
.sectionHeader{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px;
  margin-bottom:12px;
}
.sectionHeader h2{
  font-family:Oswald;
  letter-spacing:.6px;
  font-size:22px;
  display:flex; align-items:center; gap:10px;
}
.badge{
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.35);
  color:var(--muted);
  font-size:12px;
}

/* DROPDOWN LIGAS (FIX VISIBILIDAD) */
.select{
  height:38px;
  padding:0 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:#0b0b10;
  color:#fff;
  outline:none;
}
.select option{
  background:#0b0b10;
  color:#fff;
}

/* ===== Filters ===== */
.filters{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px}
.chip{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.86);
  font-size:12px;
  cursor:pointer;
  transition: transform .15s ease, border-color .2s ease, background .2s ease;
}
.chip:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18)}
.chip.active{
  border-color: rgba(124,58,237,.45);
  background: rgba(124,58,237,.12);
}

/* ===== Grid Movies/Series ===== */
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap:12px;
}
.card{
  position:relative;
  border-radius: 20px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  min-height: 320px;
  cursor:pointer;
  transition: transform .18s ease, border-color .2s ease, box-shadow .2s ease;
}
.card:hover{
  transform: translateY(-2px);
  border-color: rgba(124,58,237,.35);
  box-shadow: 0 28px 90px rgba(0,0,0,.75);
}
.poster{
  position:absolute; inset:0;
  background-size: cover;
  background-position:center;
  transform: scale(1.03);
  filter: saturate(1.05) contrast(1.02);
}
.poster::after{
  content:"";
  position:absolute; inset:0;
  background: linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.82) 70%, rgba(0,0,0,.95));
}
.cardTop{
  position:absolute; top:10px; left:10px; right:10px;
  display:flex; justify-content:space-between; align-items:center;
  gap:10px; z-index:2;
}
.tag{
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.30);
}
.tag.noLink{
  border-color: rgba(255,45,85,.35);
  color: rgba(255,180,190,.95);
}
.tag.hasLink{
  border-color: rgba(46,229,157,.35);
  color: rgba(190,255,230,.95);
}
.cardInfo{
  position:absolute; left:12px; right:12px; bottom:12px;
  z-index:2;
}
.cardInfo h3{
  font-size:14px; line-height:1.2;
  margin-bottom:6px;
  text-shadow: 0 10px 28px rgba(0,0,0,.65);
}
.meta{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  color: rgba(255,255,255,.70);
  font-size:12px;
}
.stars{display:inline-flex; align-items:center; gap:6px}
.star{
  width:10px;height:10px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius:3px;
  box-shadow:0 0 16px rgba(124,58,237,.20);
}

/* ===== Events ===== */
.eventsTop{
  display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  margin-bottom:12px;
}
.eventsTools{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  margin-bottom:14px;
}
.eventsTools .toolsRight{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.autoToggle{
  display:flex;
  gap:8px;
  align-items:center;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.80);
  font-size:12px;
  user-select:none;
  cursor:pointer;
}
.autoToggle input{ accent-color: #7c3aed; }

.btn{
  height:38px;
  padding:0 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  cursor:pointer;
}
.btn:hover{border-color:rgba(255,255,255,.18)}
.eventsGrid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap:12px;
}
.eventCard{
  border-radius:22px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.035);
  padding:14px;
  box-shadow: 0 20px 75px rgba(0,0,0,.75);
  transition: transform .15s ease, border-color .2s ease;
}
.eventCard:hover{transform:translateY(-2px); border-color:rgba(124,58,237,.28)}
.eventHdr{
  display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  margin-bottom:12px;
}
.leagueBox{display:flex; flex-direction:column; gap:2px}
.leagueName{
  font-size:12px;
  color: rgba(255,255,255,.92);
  font-weight:800;
  letter-spacing:.2px;
}
.leagueSub{color:var(--muted); font-size:11px}
.status{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.25);
  color: rgba(255,255,255,.90);
  display:flex; align-items:center; gap:8px;
}
.pulse{
  width:8px;height:8px;border-radius:999px;
  background: var(--danger);
  animation: pulse 1.2s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,45,85,.55)}
  70%{box-shadow:0 0 0 10px rgba(255,45,85,0)}
  100%{box-shadow:0 0 0 0 rgba(255,45,85,0)}
}
.match{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:12px;
  padding:10px 10px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.30);
}
.team{display:flex; align-items:center; gap:10px}
.team.right{justify-content:flex-end; text-align:right}
.teamLogo{
  width:44px;height:44px;border-radius:14px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.teamLogo img{width:100%;height:100%;object-fit:contain}
.teamName{font-weight:800; font-size:13px; line-height:1.1}
.teamSub{color: var(--muted); font-size:11px; margin-top:3px}
.mid{display:flex; flex-direction:column; align-items:center; gap:2px; min-width:84px}
.score{font-family:Oswald; font-size:26px; letter-spacing:.4px}
.clock{font-size:12px; color: var(--muted)}
.eventFoot{
  display:flex; justify-content:space-between; align-items:center;
  margin-top:10px;
  gap:10px;
  color: var(--muted);
  font-size:12px;
}
.eventActions{display:flex; gap:8px; align-items:center}
.btnMini{
  height:34px;
  padding:0 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  color: rgba(255,255,255,.92);
  cursor:pointer;
  transition: transform .15s ease, border-color .2s ease;
}
.btnMini:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18)}
.btnMini.primary{
  border-color: rgba(124,58,237,.35);
  background: rgba(124,58,237,.16);
}
.eventId{
  margin-top:8px;
  font-size:11px;
  color: rgba(255,255,255,.38);
  user-select:text;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

/* ===== Channels ===== */
.channelsGrid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap:12px;
}
.channelCard{
  border-radius:20px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  padding:12px;
  display:flex; align-items:center; justify-content:space-between;
  gap:12px;
  transition: transform .15s ease, border-color .2s ease;
}
.channelCard:hover{transform:translateY(-2px); border-color:rgba(124,58,237,.25)}
.chLeft{display:flex; align-items:center; gap:10px}
.chLogo{
  width:46px;height:46px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.30);
  overflow:hidden; display:flex; align-items:center; justify-content:center;
}
.chLogo img{width:100%;height:100%;object-fit:contain}
.chMeta b{display:block; font-size:13px}
.chMeta small{color:var(--muted); font-size:12px}
.chTag{
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  color: rgba(255,255,255,.85);
  background: rgba(0,0,0,.25);
}

/* ===== Modal player ===== */
#playerModal{
  position:fixed; inset:0;
  background: rgba(0,0,0,.78);
  display:none;
  align-items:center; justify-content:center;
  padding:16px;
  z-index:9990;
}
#playerModal.show{display:flex}
.modal{
  width:min(1100px, 96vw);
  border-radius: 22px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  box-shadow: 0 30px 120px rgba(0,0,0,.90);
  overflow:hidden;
}
.modalTop{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,.10);
}
.modalTop b{font-family:Oswald; letter-spacing:.6px}
.modalTop .x{
  width:38px;height:38px;border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  cursor:pointer;
}
.modalBody{padding:12px}
video{width:100%; border-radius:16px; background:#000}

/* ===== Responsive ===== */
@media (max-width: 860px){
  .app{grid-template-columns: 78px 1fr}
  .topbar{flex-direction:column; align-items:stretch}
  .searchWrap{max-width:none}
}

/* =========================
   PREMIUM POLISH + PAGINACI√ìN
========================= */
.filtersRow{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin:10px 0 8px;}
.filtersRow .filters{display:flex;flex-wrap:wrap;gap:10px;}
.pager{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin:8px 0 14px;}
.pagerInfo{font-size:12px;color:var(--muted);padding:0 6px;white-space:nowrap}
.pagerBtn{
  width:38px;height:34px;border-radius:12px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  display:grid;place-items:center;
  cursor:pointer;
  transition:transform .18s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
}
.pagerBtn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.18)}
.pagerBtn:disabled{opacity:.35;cursor:not-allowed;transform:none}
.pagerSelect{
  height:34px;border-radius:12px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  padding:0 10px;
  outline:none;
}
.pagerSelect:focus{border-color:rgba(166,110,255,.55);box-shadow:0 0 0 3px rgba(166,110,255,.12)}

/* nicer section entrance */
.section{animation:sectionIn .28s ease both;}
@keyframes sectionIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* Cards hover premium */
.card{transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;}
.card:hover{transform:translateY(-4px);box-shadow:0 20px 60px rgba(0,0,0,.55);border-color:rgba(166,110,255,.28)}

/* Skeletons */
.skeletonGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px}
.sCard{border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);overflow:hidden}
.sPoster{height:260px;background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.09), rgba(255,255,255,.05));background-size:200% 100%;animation:shimmer 1.15s ease infinite;}
.sLines{padding:12px 12px 16px}
.sLine{display:block;height:10px;border-radius:999px;background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.10), rgba(255,255,255,.05));background-size:200% 100%;animation:shimmer 1.15s ease infinite;margin-top:10px}
.sLine.short{width:62%}
@keyframes shimmer{0%{background-position:0% 0}100%{background-position:200% 0}}

@media(max-width:920px){
  .pager{justify-content:flex-start}
}

/* ===== Player fast iframe ===== */
.playerStage{position:relative; border-radius:16px; overflow:hidden; background:#000; border:1px solid rgba(255,255,255,.10)}
.playerLoader{
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:10px;
  background: radial-gradient(900px 600px at 50% 30%, rgba(255,255,255,.08), rgba(0,0,0,.65));
  backdrop-filter: blur(6px);
  z-index:2;
}
.playerLoader.hide{display:none}
.spinner{
  width:38px;height:38px;border-radius:999px;
  border:3px solid rgba(255,255,255,.18);
  border-top-color: rgba(255,255,255,.85);
  animation: spin2 .9s linear infinite;
}
@keyframes spin2{to{transform:rotate(360deg)}}
.loaderTxt{font-size:12px;color:rgba(255,255,255,.72)}
/* Reduce layout work for hidden sections */
.section{content-visibility:auto; contain-intrinsic-size: 800px}

</style>
</head>

<body>

<!-- INTRO -->
<div id="intro" title="Click para saltar">
  <div class="introCard">
    <div class="introGlow"></div>
    <div class="introInner">
      <div class="introOrb"></div>
      <div class="introText">
        <b>FLUXO</b>
        <p>Sports + Movies ‚Ä¢ Interfaz estilo cine.</p>
        <div class="introBar"><i></i></div>
        <div class="introHint">Cargando‚Ä¶ (clic para saltar)</div>
      </div>
    </div>
  </div>
</div>


<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logoMini" title="FLUXO"><span>F</span></div>

    <div class="navBtn active" data-view="canales">
      <i style="-webkit-mask-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M21 17H3V7h18v10zm0-12H3a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z%22/></svg>');"></i>
      <small>CANALES</small>
    </div>

    <div class="navBtn" data-view="peliculas">
      <i style="-webkit-mask-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M4 6h16v12H4V6zm16-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z%22/></svg>');"></i>
      <small>PEL√çCULAS</small>
    </div>

    <div class="navBtn" data-view="series">
      <i style="-webkit-mask-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M7 7h10v10H7V7zm12-3H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z%22/></svg>');"></i>
      <small>SERIES</small>
    </div>
    <div class="navBtn" data-view="doramas">
      <i style="-webkit-mask-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M4 6h16v10H4V6zm0 12h16v2H4v-2zm3-9v6l5-3-5-3z%22/></svg>');"></i>
      <small>DORAMAS</small>
    </div>


    <div class="navBtn" data-view="eventos">
      <i style="-webkit-mask-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z%22/></svg>');"></i>
      <small>EVENTOS</small>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="topLeft">
        <div class="logoMini" style="width:44px;height:44px;border-radius:16px"><span>F</span></div>
        <div class="brandLine">
          <b>FLUXO</b>
          <small>TMDB (pel√≠culas/series) ‚Ä¢ ESPN (eventos)</small>
        </div>
      </div>

      <div class="searchWrap">
        <input class="search" id="searchInput" placeholder="Buscar pel√≠cula o serie..." />
        <div class="pillTop" id="modeBtn"><span class="dot"></span><span id="modeTxt">Modo cine</span></div>
        <div class="pillTop" id="fullBtn"><span class="dot" style="background:linear-gradient(135deg,#fff,#777)"></span>Full</div>
      </div>
    </div>

    <!-- CANALES -->
    <section class="section" id="view-canales">
      <div class="sectionHeader">
        <h2>üì∫ Canales</h2>
        <span class="badge">Links desde c√≥digo</span>
      </div>
      <div class="channelsGrid" id="channelsGrid"></div>
    </section>

    <!-- PELICULAS -->
    <section class="section" id="view-peliculas" style="display:none">
      <div class="sectionHeader">
        <h2>üé¨ Pel√≠culas</h2>
        <span class="badge" id="moviesBadge">Cargando‚Ä¶</span>
      </div>
      <div class="filters" id="movieFilters">
        <div class="chip active" data-type="popular">Popular</div>
        <div class="chip" data-type="top_rated">Top</div>
        <div class="chip" data-type="now_playing">Reciente</div>
        <div class="chip" data-type="upcoming">Pr√≥ximas</div>
      </div>

      <div class="pager" id="moviesPager">
        <button class="pagerBtn" id="moviesPrev" aria-label="Anterior">‚Äπ</button>
        <div class="pagerInfo"><span id="moviesPageLabel">P√°gina 1/20</span></div>
        <select class="pagerSelect" id="moviesPageSelect" aria-label="P√°gina"></select>
        <button class="pagerBtn" id="moviesNext" aria-label="Siguiente">‚Ä∫</button>
      </div>

      <div class="grid" id="moviesGrid"></div>
    </section>

    <!-- SERIES -->
    <section class="section" id="view-series" style="display:none">
      <div class="sectionHeader">
        <h2>üì∫ Series</h2>
        <span class="badge" id="seriesBadge">Cargando‚Ä¶</span>
      </div>
      <div class="filters" id="seriesFilters">
        <div class="chip active" data-type="popular">Popular</div>
        <div class="chip" data-type="top_rated">Top</div>
        <div class="chip" data-type="on_the_air">En emisi√≥n</div>
        <div class="chip" data-type="airing_today">Hoy</div>
      </div>

      <div class="pager" id="seriesPager">
        <button class="pagerBtn" id="seriesPrev" aria-label="Anterior">‚Äπ</button>
        <div class="pagerInfo"><span id="seriesPageLabel">P√°gina 1/20</span></div>
        <select class="pagerSelect" id="seriesPageSelect" aria-label="P√°gina"></select>
        <button class="pagerBtn" id="seriesNext" aria-label="Siguiente">‚Ä∫</button>
      </div>

      <div class="grid" id="seriesGrid"></div>
    </section>

    <!-- DORAMAS -->
    <section class="section" id="view-doramas" style="display:none">
      <div class="sectionHeader">
        <h2>üéé Doramas</h2>
        <span class="badge" id="doramasBadge">Cargando‚Ä¶</span>
      </div>

      <div class="filtersRow">
        <div class="filters" id="doramaLangFilters">
          <div class="chip active" data-lang="ko">K-Drama</div>
          <div class="chip" data-lang="ja">J-Drama</div>
          <div class="chip" data-lang="zh">C-Drama</div>
        </div>
        <div class="filters" id="doramaTypeFilters">
          <div class="chip active" data-type="trending">Tendencias</div>
          <div class="chip" data-type="top">Top</div>
        </div>
      </div>

      <div class="pager" id="doramasPager">
        <button class="pagerBtn" id="doramasPrev" aria-label="Anterior">‚Äπ</button>
        <div class="pagerInfo"><span id="doramasPageLabel">P√°gina 1/20</span></div>
        <select class="pagerSelect" id="doramasPageSelect" aria-label="P√°gina"></select>
        <button class="pagerBtn" id="doramasNext" aria-label="Siguiente">‚Ä∫</button>
      </div>

      <div class="grid" id="doramasGrid"></div>
    </section>

    <!-- EVENTOS -->
    <section class="section" id="view-eventos" style="display:none">
      <div class="sectionHeader">
        <h2>üèüÔ∏è Eventos</h2>
        <span class="badge" id="eventsBadge">Hoy</span>
      </div>

      <div class="eventsTop">
        <select class="select" id="leagueSelect">
          <option value="nba">NBA</option>
          <option value="eng.1">Premier League</option>
          <option value="eng.2">Championship</option>
          <option value="esp.1">LaLiga</option>
          <option value="ita.1">Serie A</option>
          <option value="ger.1">Bundesliga</option>
        </select>
        <button class="btn" id="refreshEvents">Actualizar</button>
        <span class="eventId" id="eventsHint"></span>
      </div>

      
      <div class="eventsTools">
        <div class="chips" id="eventFilters">
          <button class="chip active" data-filter="all">Todos</button>
          <button class="chip" data-filter="live">En vivo</button>
          <button class="chip" data-filter="fav">Favoritos</button>
          <button class="chip" data-filter="nolink">Sin link</button>
        </div>

        <div class="toolsRight">
          <input class="search" id="eventSearch" placeholder="Buscar equipo o evento..." />
          <label class="autoToggle"><input type="checkbox" id="autoRefresh" /> Auto</label>
        </div>
      </div>

      <div class="eventsGrid" id="eventsGrid"></div>
    </section>
  </main>
</div>

<!-- PLAYER MODAL -->
<div id="playerModal">
  <div class="modal">
    <div class="modalTop">
      <b id="playerTitle">Reproductor</b>
      <div class="x" id="closePlayer">‚úï</div>
    </div>
    <div class="modalBody">
            <div class="playerStage">
        <div class="playerLoader" id="playerLoader">
          <div class="spinner"></div>
          <div class="loaderTxt">Cargando‚Ä¶</div>
        </div>

        <!-- IFRAME PLAYER (r√°pido) -->
        <iframe id="playerFrame"
          title="Player"
          style="width:100%; aspect-ratio:16/9; border:0; display:block; background:#000;"
          allow="autoplay; encrypted-media; picture-in-picture; fullscreen"
          allowfullscreen
          referrerpolicy="no-referrer"
          loading="eager"></iframe>
      </div>

      <!-- Hint -->
      <div class="eventId" id="playerHint"></div>
    
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const TMDB_KEY = "92328c13578b65a268efe3419fc0ec92";
const TMDB_IMG = "https://image.tmdb.org/t/p/w780";

/* ====== LINKS DE EVENTOS (COMPARTIDOS EN NETLIFY) ======
   ‚úÖ Para que TODOS vean los mismos links:
   - Crea /data/events.json en tu proyecto (Netlify lo sirve p√∫blico)
   - Ah√≠ pegas tus links por eventId

   Formato recomendado (/data/events.json):
   {
     "updatedAt": "2026-01-31T00:00:00-05:00",
     "links": {
       "401547123": "https://tu-link-legal.m3u8"
     }
   }
*/
// URL del JSON con links (por defecto, el archivo que viaja con tu deploy en Netlify).
// Puedes sobreescribirlo con un par√°metro en la URL:
//   ?links=https://raw.githubusercontent.com/<user>/<repo>/main/data/events.json
const EVENTS_JSON_URL = (() => {
  try {
    const u = new URL(location.href);
    return u.searchParams.get("links") || "/data/events.json";
  } catch {
    return "/data/events.json";
  }
})();

let EVENT_LINKS = {};          // links de eventos cargados desde events.json
let EVENT_LINKS_UPDATED_AT = "";

// links de canales cargados desde events.json (channels.links)
let CHANNEL_LINKS = {};
let CHANNEL_LINKS_UPDATED_AT = "";

let CHANNEL_LINKS = {};        // links de canales cargados desde events.json
let CHANNEL_LINKS_UPDATED_AT = "";

// Estado de UI de eventos
let EVENTS_RAW = [];
let EVENT_FILTER = "all";
let EVENT_SEARCH = "";
let EVENTS_LEAGUE_INFO = null;
let AUTO_TIMER = null;

// Favoritos (solo local, por navegador)
const FAV_KEY = "fluxoFavEvents";
const FAVS = new Set(JSON.parse(localStorage.getItem(FAV_KEY) || "[]").map(String));
function saveFavs(){ localStorage.setItem(FAV_KEY, JSON.stringify([...FAVS])); }
function toggleFav(id){
  id = String(id);
  if(FAVS.has(id)) FAVS.delete(id); else FAVS.add(id);
  saveFavs();
  renderEvents();
}

function renderEventSkeletons(n=4){
  return Array.from({length:n}).map(()=>`<div class="eventCard skel"></div>`).join("");
}

function renderMediaSkeletons(n=9){
  return Array.from({length:n}).map(()=>`<div class="card skel"></div>`).join("");
}

function eventMeta(evt){
  const comp = evt?.competitions?.[0];
  const competitors = comp?.competitors || [];
  const home = competitors.find(c=>c.homeAway==="home") || competitors[0] || {};
  const away = competitors.find(c=>c.homeAway==="away") || competitors[1] || {};
  const eventId = String(evt?.id || comp?.id || "");
  const state = comp?.status?.type?.state || "";
  const dt = new Date(comp?.date || evt?.date || Date.now());
  const title = `${away?.team?.displayName || away?.team?.shortDisplayName || "Equipo"} vs ${home?.team?.displayName || home?.team?.shortDisplayName || "Equipo"}`;
  const hasLink = !!EVENT_LINKS[eventId];
  const fav = FAVS.has(eventId);
  const isLive = state === "in";
  return { eventId, state, dt, title: title.toLowerCase(), hasLink, fav, isLive };
}

function renderEvents(){
  const grid = $("#eventsGrid");
  const badge = $("#eventsBadge");
  const leagueKey = $("#leagueSelect").value;
  const leagueInfo = EVENTS_LEAGUE_INFO;

  let list = (EVENTS_RAW || []).slice();

  // search
  const q = (EVENT_SEARCH || "").trim().toLowerCase();
  if(q){
    list = list.filter(e=> eventMeta(e).title.includes(q));
  }

  // filter
  if(EVENT_FILTER === "live"){
    list = list.filter(e=> eventMeta(e).isLive);
  }else if(EVENT_FILTER === "fav"){
    list = list.filter(e=> eventMeta(e).fav);
  }else if(EVENT_FILTER === "nolink"){
    list = list.filter(e=> !eventMeta(e).hasLink);
  }

  // sort: live -> upcoming -> finished
  const rank = (s)=> (s==="in"?0:(s==="pre"?1:2));
  list.sort((a,b)=>{
    const A = eventMeta(a), B = eventMeta(b);
    const r = rank(A.state) - rank(B.state);
    if(r!==0) return r;
    if(A.state === "pre") return A.dt - B.dt;
    if(A.state === "post") return B.dt - A.dt;
    return A.dt - B.dt;
  });

  if(!list.length){
    badge.textContent = "0 eventos";
    grid.innerHTML = `<div class="eventId">No hay resultados con ese filtro.</div>`;
    return;
  }

  grid.innerHTML = list.map(evt=>renderEventCard(evt, leagueKey, leagueInfo)).join("");
  badge.textContent = `${list.length} eventos`;
}

// Carga links compartidos (los ven todos)
async function loadEventLinks(){
  try{
    // Cache-bust y no-cache para que Netlify/Github Raw no te sirvan una versi√≥n vieja
    const url = new URL(EVENTS_JSON_URL, location.href);
    url.searchParams.set("ts", String(Date.now()));
    const res = await fetch(url.toString(), { cache: "no-store" });
    if(!res.ok) throw new Error("No se pudo cargar events.json");
    const data = await res.json();

    // Soportamos 2 formatos:
    // 1) { updatedAt, links: {...} }
    // 2) { updatedAt, events:{links:{...}}, channels:{links:{...}} }
    const ev = (data && data.links) ? data.links : (data && data.events && data.events.links) ? data.events.links : {};
    const ch = (data && data.channels && data.channels.links) ? data.channels.links : {};

    EVENT_LINKS = ev || {};
    CHANNEL_LINKS = ch || {};
    EVENT_LINKS_UPDATED_AT = (data && data.updatedAt) ? data.updatedAt : "";
    CHANNEL_LINKS_UPDATED_AT = EVENT_LINKS_UPDATED_AT;

    // Inyecta los links cargados en los canales (sin tocar el dise√±o)
    applyChannelLinks(CHANNEL_LINKS);
    return true;
  }catch(e){
    EVENT_LINKS = {};
    EVENT_LINKS_UPDATED_AT = "";
    CHANNEL_LINKS = {};
    CHANNEL_LINKS_UPDATED_AT = "";
    return false;
  }
}


/* Si est√° en true, muestra el eventId bajo cada partido (para que lo copies r√°pido) */
const DEV_SHOW_EVENT_ID = true;

/* =========================
   DATA: Canales (edita aqu√≠)
========================= */
const CHANNELS = [
  // `key` debe coincidir con data/events.json -> channels.links.{key}
  { key:"espn",      name:"ESPN",        logo:"https://upload.wikimedia.org/wikipedia/commons/2/2f/ESPN_wordmark.svg", stream:"" },
  { key:"espn2",     name:"ESPN 2",      logo:"https://upload.wikimedia.org/wikipedia/commons/2/2f/ESPN_wordmark.svg", stream:"" },
  { key:"foxsports", name:"Fox Sports",  logo:"https://upload.wikimedia.org/wikipedia/commons/9/9e/Fox_Sports_logo.svg", stream:"" },
  { key:"tnt",       name:"TNT Sports",  logo:"https://upload.wikimedia.org/wikipedia/commons/8/8b/TNT_Logo_2016.svg", stream:"" },
  { key:"dazn",      name:"DAZN",        logo:"https://upload.wikimedia.org/wikipedia/commons/6/6c/DAZN_Logo.svg", stream:"" },
  { key:"nbatv",     name:"NBA TV",      logo:"https://upload.wikimedia.org/wikipedia/commons/3/3f/NBA_TV.svg", stream:"" },
  { key:"ufcpass",   name:"UFC Fight Pass", logo:"https://upload.wikimedia.org/wikipedia/commons/0/0c/UFC_Fight_Pass_logo.svg", stream:"" },
  { key:"univision", name:"Univision",   logo:"https://upload.wikimedia.org/wikipedia/commons/3/3b/Univision_2019_logo.svg", stream:"" },
  { key:"telemundo", name:"Telemundo",   logo:"https://upload.wikimedia.org/wikipedia/commons/0/0a/Telemundo_logo_2018.svg", stream:"" },
];

function applyChannelLinks(map){
  if(!map || typeof map !== "object") return;
  CHANNELS.forEach(ch=>{
    const k = (ch.key || "").toLowerCase();
    if(k && typeof map[k] === "string" && map[k].trim()){
      ch.stream = map[k].trim();
    }
  });
}

/* =========================
   Helpers
========================= */
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>document.querySelectorAll(q);
function escapeQuotes(s){ return (s||"").replaceAll("'", "\\'"); }

/* =========================
   INTRO
========================= */
function hideIntro(){
  const el = $("#intro");
  if(!el || el.classList.contains("hide")) return;
  el.classList.add("hide");
  setTimeout(()=>{ try{el.remove()}catch(e){} }, 900);
}
$("#intro")?.addEventListener("click", hideIntro);
// Auto cerrar intro (robusto: incluso si algo falla)
setTimeout(hideIntro, 1800);
window.addEventListener("load", ()=> setTimeout(hideIntro, 900));
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" || e.key === "Enter" || e.key === " ") hideIntro();
});
// Si por alguna raz√≥n se queda pegada (errores / file://), la elimina igual
let __introFailsafeN = 0;
const __introFailsafe = setInterval(()=>{
  __introFailsafeN++;
  const el = document.getElementById("intro");
  if(!el){ clearInterval(__introFailsafe); return; }
  if(__introFailsafeN >= 10){ // ~5s
    try{ el.classList.add("hide"); }catch(e){}
    setTimeout(()=>{ try{el.remove()}catch(e){} }, 900);
    clearInterval(__introFailsafe);
  }
}, 500);

/* Nota:
   Este reproductor debe usarse con enlaces autorizados.
   No a√±ade seguridad real; solo es una interfaz. */


/* =========================
   Views
========================= */
const views = {
  canales: $("#view-canales"),
  peliculas: $("#view-peliculas"),
  series: $("#view-series"),
  doramas: $("#view-doramas"),
  eventos: $("#view-eventos"),
};

$$(".navBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $$(".navBtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const view = btn.dataset.view;

    Object.keys(views).forEach(k=> views[k].style.display = (k===view? "block":"none"));

    if(view==="peliculas") $("#searchInput").placeholder="Buscar pel√≠cula‚Ä¶";
    else if(view==="series") $("#searchInput").placeholder="Buscar serie‚Ä¶";
    else if(view==="doramas") $("#searchInput").placeholder="Buscar dorama‚Ä¶";
    else $("#searchInput").placeholder="Buscar pel√≠cula o serie‚Ä¶";

    if(view==="peliculas" && !moviesLoaded){ loadMovies(1).then(()=>moviesLoaded=true).catch(()=>{}); }
    if(view==="series" && !seriesLoaded){ loadSeries(1).then(()=>seriesLoaded=true).catch(()=>{}); }
    if(view==="doramas" && !doramasLoaded){ loadDoramas(1).then(()=>doramasLoaded=true).catch(()=>{}); }
    if(view==="eventos") loadEvents();
  });
});

$("#fullBtn").addEventListener("click", ()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen?.();
  else document.exitFullscreen?.();
});

/* =========================
   Player
========================= */
function isYouTube(u){
  if(!u) return false;
  return /(?:youtube\.com\/watch\?v=|youtu\.be\/)/i.test(u);
}
function toYouTubeEmbed(u){
  try{
    const url = new URL(u);
    let id = "";
    if(url.hostname.includes("youtu.be")){
      id = url.pathname.replace("/","");
    }else{
      id = url.searchParams.get("v") || "";
    }
    if(!id) return "";
    return `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0&modestbranding=1`;
  }catch(e){ return ""; }
}

function openStream(title, url){
  const modal = $("#playerModal");
  const frame = $("#playerFrame");
  const loader = $("#playerLoader");
  const hint = $("#playerHint");

  $("#playerTitle").textContent = title || "Reproductor";
  hint.textContent = "";

  const u = String(url || "").trim();
  if(!u){
    hint.textContent = "Sin enlace para este evento.";
    modal.classList.add("show");
    return;
  }

  // Pausa auto-refresh mientras reproduces (evita que la red/CPU compita con el player)
  window.__fluxoModalOpen = true;

  // Preconnect al dominio del iframe para acelerar el primer byte
  try{
    const origin = new URL(u, location.href).origin;
    if(origin && !document.querySelector(`link[data-preconnect="${origin}"]`)){
      const l = document.createElement("link");
      l.rel = "preconnect";
      l.href = origin;
      l.crossOrigin = "anonymous";
      l.setAttribute("data-preconnect", origin);
      document.head.appendChild(l);

      const d = document.createElement("link");
      d.rel = "dns-prefetch";
      d.href = origin.replace(/^https?:/, "");
      document.head.appendChild(d);
    }
  }catch(e){}

  // UI primero (abre modal instant√°neo)
  loader.classList.remove("hide");
  modal.classList.add("show");

  // Limpia src previo para evitar que el navegador "congele" por p√°ginas pesadas previas
  frame.src = "about:blank";

  // Setea el src en el siguiente frame para que el modal pinte antes
  requestAnimationFrame(()=>{
    // Si es YouTube normal, normaliza a /embed para que cargue m√°s directo
    let finalUrl = u;
    if(/(?:youtube\.com\/watch\?v=|youtu\.be\/)/i.test(u)){
      const m1 = u.match(/[?&]v=([^&]+)/i);
      const m2 = u.match(/youtu\.be\/([^?&]+)/i);
      const vid = (m1 && m1[1]) || (m2 && m2[1]) || "";
      if(vid) finalUrl = `https://www.youtube.com/embed/${vid}?autoplay=1&mute=0&controls=1&rel=0`;
    }
    frame.src = finalUrl;
  });

  // Loader off cuando el iframe termine de cargar
  let safety = setTimeout(()=>loader.classList.add("hide"), 12000);
  frame.onload = ()=>{
    clearTimeout(safety);
    loader.classList.add("hide");
  };
}



$("#closePlayer").addEventListener("click", ()=>{
  $("#playerModal").classList.remove("show");
  const frame = $("#playerFrame");
  if(frame) frame.src = "about:blank";
  const loader = $("#playerLoader");
  if(loader) loader.classList.remove("hide");
  $("#playerHint").textContent = "";
  window.__fluxoModalOpen = false;
});
$("#playerModal").addEventListener("click", (e)=>{
  if(e.target.id==="playerModal") $("#closePlayer").click();
});

/* =========================
   CANALES
========================= */
function renderChannels(){
  const grid = $("#channelsGrid");
  grid.innerHTML = CHANNELS.map(ch=>{
    const has = !!ch.stream;
    return `
      <div class="channelCard" onclick="${has?`openStream('${escapeQuotes(ch.name)}','${escapeQuotes(ch.stream)}')`:`alert('Sin link para este canal. Agrega/edita data/events.json ‚Üí channels.links.${escapeQuotes(ch.key)}')`}">
        <div class="chLeft">
          <div class="chLogo">
            <img src="${ch.logo}" onerror="this.style.display='none'; this.parentNode.textContent='üì∫';" />
          </div>
          <div class="chMeta">
            <b>${ch.name}</b>
            <small>${has ? "Listo" : "Sin link"}</small>
          </div>
        </div>
        <div class="chTag">${has ? "PLAY" : "NO LINK"}</div>
      </div>
    `;
  }).join("");
}

// Carga links (events + channels) y luego pinta canales.
loadEventLinks().finally(renderChannels);

/* =========================
   MOVIES + SERIES (TMDB)
========================= */
const MAX_PAGE = 20;

let movieType = "popular";
let seriesType = "popular";

let moviePage = 1;
let seriesPage = 1;

let doramaLang = "ko";       // ko | ja | zh
let doramaType = "trending"; // trending | top
let doramaPage = 1;

let moviesCache = [];
let seriesCache = [];
let doramasCache = [];

let moviesLoaded = false;
let seriesLoaded = false;
let doramasLoaded = false;

function clampPage(p){
  const n = Number(p)||1;
  return Math.max(1, Math.min(MAX_PAGE, n));
}

function fillPagerOptions(selectEl){
  if(!selectEl || selectEl.dataset.filled) return;
  const frag = document.createDocumentFragment();
  for(let i=1;i<=MAX_PAGE;i++) {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = "P√°gina " + i;
    frag.appendChild(opt);
  }
  selectEl.appendChild(frag);
  selectEl.dataset.filled = "1";
}

function syncPagerUI(prefix, page){
  const label = document.getElementById(prefix+"PageLabel");
  const sel = document.getElementById(prefix+"PageSelect");
  const prev = document.getElementById(prefix+"Prev");
  const next = document.getElementById(prefix+"Next");
  if(label) label.textContent = "P√°gina " + page + "/" + MAX_PAGE;
  if(sel) sel.value = String(page);
  if(prev) prev.disabled = page<=1;
  if(next) next.disabled = page>=MAX_PAGE;
}

function renderMediaSkeletons(n=12){
  let out = '<div class="skeletonGrid">';
  for(let i=0;i<n;i++) {
    out += '<div class="sCard"><div class="sPoster"></div><div class="sLines"><span class="sLine"></span><span class="sLine short"></span></div></div>';
  }
  out += "</div>";
  return out;
}

async function tmdbFetch(path){
  const cacheKey = `tmdb:${path}`;
  const ttl = 20 * 60 * 1000; // 20 min
  try{
    const cached = JSON.parse(sessionStorage.getItem(cacheKey) || "null");
    if(cached && (Date.now() - cached.t) < ttl) return cached.v;
  }catch(e){}

  const url = `https://api.themoviedb.org/3/${path}${path.includes("?")?"&":"?"}api_key=${TMDB_KEY}&language=es-ES`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("TMDB error");
  const j = await res.json();

  try{ sessionStorage.setItem(cacheKey, JSON.stringify({t:Date.now(), v:j})); }catch(e){}
  return j;
}
function makeCard(item, kind){
  const title = kind==="movie" ? (item.title||"") : (item.name||"");
  const date = kind==="movie" ? (item.release_date||"") : (item.first_air_date||"");
  const year = date ? date.slice(0,4) : "‚Äî";
  const rating = (item.vote_average ? item.vote_average.toFixed(1) : "‚Äî");
  const img = item.poster_path || item.backdrop_path ? `${TMDB_IMG}${item.poster_path || item.backdrop_path}` : "";
  const stream = item.stream || "";
  const has = !!stream;

  return `
  <div class="card" onclick="${has?`openStream('${escapeQuotes(title)}','${escapeQuotes(stream)}')`:`alert('Aqu√≠ igual puedes poner links desde el c√≥digo si quieres.')`}">
    <div class="poster" style="background-image:url('${img}')"></div>
    <div class="cardTop">
      <span class="tag">${kind.toUpperCase()}</span>
      <span class="tag ${has ? "hasLink":"noLink"}">${has ? "PLAY" : "NO LINK"}</span>
    </div>
    <div class="cardInfo">
      <h3>${title}</h3>
      <div class="meta">
        <span>${year}</span>
        <span class="stars"><span class="star"></span>${rating}</span>
      </div>
    </div>
  </div>`;
}
async function loadMovies(page=1){
  moviePage = clampPage(page);
  document.getElementById("moviesBadge").textContent = "Cargando‚Ä¶";
  document.getElementById("moviesGrid").innerHTML = renderMediaSkeletons(12);
  syncPagerUI("movies", moviePage);
  try{
    const data = await tmdbFetch("movie/" + movieType + "?page=" + moviePage);
    const results = (data && data.results ? data.results : []).slice(0,24).map(x => ({...x, stream:""}));
    moviesCache = results;
    document.getElementById("moviesGrid").innerHTML = results.map(x=>makeCard(x,"movie")).join("");
    document.getElementById("moviesBadge").textContent = "P√°gina " + moviePage + "/" + MAX_PAGE + " ‚Ä¢ " + results.length + " t√≠tulos";
  }catch(e){
    document.getElementById("moviesBadge").textContent = "Error TMDB";
    document.getElementById("moviesGrid").innerHTML = '<div class="eventId">No se pudo cargar TMDB.</div>';
  }
  moviesLoaded = true;
}
async function loadSeries(page=1){
  seriesPage = clampPage(page);
  document.getElementById("seriesBadge").textContent = "Cargando‚Ä¶";
  document.getElementById("seriesGrid").innerHTML = renderMediaSkeletons(12);
  syncPagerUI("series", seriesPage);
  try{
    const data = await tmdbFetch("tv/" + seriesType + "?page=" + seriesPage);
    const results = (data && data.results ? data.results : []).slice(0,24).map(x => ({...x, stream:""}));
    seriesCache = results;
    document.getElementById("seriesGrid").innerHTML = results.map(x=>makeCard(x,"series")).join("");
    document.getElementById("seriesBadge").textContent = "P√°gina " + seriesPage + "/" + MAX_PAGE + " ‚Ä¢ " + results.length + " t√≠tulos";
  }catch(e){
    document.getElementById("seriesBadge").textContent = "Error TMDB";
    document.getElementById("seriesGrid").innerHTML = '<div class="eventId">No se pudo cargar TMDB.</div>';
  }
  seriesLoaded = true;
}

async function loadDoramas(page=1){
  doramaPage = clampPage(page);
  document.getElementById("doramasBadge").textContent = "Cargando‚Ä¶";
  document.getElementById("doramasGrid").innerHTML = renderMediaSkeletons(12);
  syncPagerUI("doramas", doramaPage);
  try{
    let path = "";
    if(doramaType==="top"){
      path = "discover/tv?with_original_language=" + doramaLang + "&sort_by=vote_average.desc&vote_count.gte=200&page=" + doramaPage;
    } else {
      path = "discover/tv?with_original_language=" + doramaLang + "&sort_by=popularity.desc&page=" + doramaPage;
    }
    const data = await tmdbFetch(path);
    const results = (data && data.results ? data.results : []).slice(0,24).map(x => ({...x, stream:""}));
    doramasCache = results;
    document.getElementById("doramasGrid").innerHTML = results.map(x=>makeCard(x,"dorama")).join("");
    const langName = (doramaLang==="ko"?"K-Drama":(doramaLang==="ja"?"J-Drama":"C-Drama"));
    const typeName = (doramaType==="top"?"Top":"Tendencias");
    document.getElementById("doramasBadge").textContent = langName + " ‚Ä¢ " + typeName + " ‚Ä¢ P√°gina " + doramaPage + "/" + MAX_PAGE;
  }catch(e){
    document.getElementById("doramasBadge").textContent = "Error TMDB";
    document.getElementById("doramasGrid").innerHTML = '<div class="eventId">No se pudo cargar TMDB.</div>';
  }
  doramasLoaded = true;
}

$("#movieFilters").addEventListener("click",(e)=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#movieFilters .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  movieType = chip.dataset.type;
  document.getElementById("searchInput").value="";
  loadMovies(1);
});
$("#seriesFilters").addEventListener("click",(e)=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#seriesFilters .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  seriesType = chip.dataset.type;
  document.getElementById("searchInput").value="";
  loadSeries(1);
});
/* Doramas filters */
$("#doramaLangFilters")?.addEventListener("click",(e)=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#doramaLangFilters .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  doramaLang = chip.dataset.lang || "ko";
  $("#searchInput").value="";
  loadDoramas(1);
});
$("#doramaTypeFilters")?.addEventListener("click",(e)=>{
  const chip = e.target.closest(".chip"); if(!chip) return;
  $$("#doramaTypeFilters .chip").forEach(c=>c.classList.remove("active"));
  chip.classList.add("active");
  doramaType = chip.dataset.type || "trending";
  $("#searchInput").value="";
  loadDoramas(1);
});

/* Pagination controls (1..20) */
function wirePager(prefix, loadFn){
  const sel = document.getElementById(prefix+"PageSelect");
  fillPagerOptions(sel);
  syncPagerUI(prefix, 1);

  const getPage = ()=> (prefix==="movies"?moviePage : prefix==="series"?seriesPage : doramaPage);

  document.getElementById(prefix+"Prev")?.addEventListener("click", ()=> loadFn(getPage()-1));
  document.getElementById(prefix+"Next")?.addEventListener("click", ()=> loadFn(getPage()+1));
  sel?.addEventListener("change", ()=> loadFn(Number(sel.value)||1));
}
wirePager("movies", loadMovies);
wirePager("series", loadSeries);
wirePager("doramas", loadDoramas);

$("#searchInput").addEventListener("input", ()=>{
  const q = $("#searchInput").value.trim().toLowerCase();
  const moviesOn = $("#view-peliculas").style.display !== "none";
  const seriesOn = $("#view-series").style.display !== "none";
  const doramasOn = $("#view-doramas").style.display !== "none";

  if(moviesOn){
    const list = !q ? moviesCache : moviesCache.filter(m => (m.title||"").toLowerCase().includes(q));
    $("#moviesGrid").innerHTML = list.map(x=>makeCard(x,"movie")).join("");
    $("#moviesBadge").textContent = q ? `${list.length} resultados` : `P√°gina ${moviePage}/${MAX_PAGE} ‚Ä¢ ${list.length} t√≠tulos`;
  }
  if(seriesOn){
    const list = !q ? seriesCache : seriesCache.filter(s => (s.name||"").toLowerCase().includes(q));
    $("#seriesGrid").innerHTML = list.map(x=>makeCard(x,"series")).join("");
    $("#seriesBadge").textContent = q ? `${list.length} resultados` : `P√°gina ${seriesPage}/${MAX_PAGE} ‚Ä¢ ${list.length} t√≠tulos`;
  }
  if(doramasOn){
    const list = !q ? doramasCache : doramasCache.filter(d => (d.name||"").toLowerCase().includes(q));
    $("#doramasGrid").innerHTML = list.map(x=>makeCard(x,"dorama")).join("");
    if(q) $("#doramasBadge").textContent = `${list.length} resultados`;
  }
});
/* =========================
   EVENTOS (ESPN)
========================= */
function todayYYYYMMDD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}${m}${da}`;
}
function fmtLocalTime(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString(undefined, { weekday:"short", hour:"2-digit", minute:"2-digit" });
  }catch(e){ return "‚Äî"; }
}
function statusLabel(competition){
  const st = competition?.status?.type;
  if(!st) return {txt:"PRONTO", live:false};
  if(st.state==="in") return {txt:"EN VIVO", live:true};
  if(st.state==="post") return {txt:"FINAL", live:false};
  return {txt:"PRONTO", live:false};
}
async function fetchESPNScoreboard(leagueKey){
  const date = todayYYYYMMDD();
  if(leagueKey==="nba"){
    const url = `https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard?dates=${date}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("ESPN NBA error");
    return await res.json();
  }
  const url = `https://site.api.espn.com/apis/site/v2/sports/soccer/${leagueKey}/scoreboard?dates=${date}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("ESPN Soccer error");
  return await res.json();
}
function getTeamBlock(competitor){
  const team = competitor?.team || {};
  return {
    logo: team?.logo || "",
    name: team?.shortDisplayName || team?.displayName || "Equipo",
    abbr: team?.abbreviation || "",
    score: competitor?.score ?? ""
  };
}
function leagueFromResponse(data, fallbackKey){
  const lg = data?.leagues?.[0];
  const name = lg?.name || lg?.abbreviation || fallbackKey;
  const abbr = lg?.abbreviation || "";
  const showSub = (abbr && lg?.name && lg.name !== abbr) ? abbr : "";
  return { name, sub: showSub };
}

function getEventLinkById(eventId){
  return EVENT_LINKS[eventId] || "";
}

function renderEventCard(evt, leagueKey, leagueInfo){
  const comp = evt?.competitions?.[0];
  const competitors = comp?.competitors || [];
  const home = competitors.find(c=>c.homeAway==="home") || competitors[0];
  const away = competitors.find(c=>c.homeAway==="away") || competitors[1];

  const A = getTeamBlock(away);
  const H = getTeamBlock(home);

  const st = statusLabel(comp);
  const startISO = comp?.date || evt?.date || "";
  const when = startISO ? fmtLocalTime(startISO) : "‚Äî";

  let clockTxt = "";
  const s = comp?.status;
  if(s?.type?.state==="in"){
    const c = s?.displayClock || "";
    const p = s?.period ? `Q${s.period}` : (s?.type?.detail || "");
    clockTxt = [p, c].filter(Boolean).join(" ‚Ä¢ ");
  } else if(s?.type?.state==="post"){
    clockTxt = s?.type?.shortDetail || "Final";
  } else {
    clockTxt = when;
  }

  const eventId = String(evt?.id || comp?.id || `${leagueKey}_${A.abbr}_${H.abbr}_${startISO}`);
  const matchTitle = `${A.name} vs ${H.name}`;
  const link = getEventLinkById(eventId);

  if(DEV_SHOW_EVENT_ID){
    console.log("[FLUXO EVENT ID]", eventId, matchTitle);
  }

  const action = link
    ? `openStream('${escapeQuotes(matchTitle)}','${escapeQuotes(link)}')`
    : `alert('No hay link para este evento en /data/events.json.\\n\\nID: ${eventId}')`;

  return `
  <div class="eventCard">
    <div class="eventHdr">
      <div class="leagueBox">
        <div class="leagueName">${leagueInfo.name}</div>
        <div class="leagueSub">${leagueInfo.sub || ""}</div>
      </div>
      <div class="status">${st.live?`<span class="pulse"></span>`:""}${st.txt}</div>
    </div>

    <div class="match">
      <div class="team">
        <div class="teamLogo"><img src="${A.logo}" onerror="this.style.display='none'; this.parentNode.textContent='üè∑Ô∏è';"></div>
        <div>
          <div class="teamName">${A.name}</div>
          <div class="teamSub">${A.abbr || ""}</div>
        </div>
      </div>

      <div class="mid">
        <div class="score">${A.score || "‚Äî"} <span style="opacity:.55">:</span> ${H.score || "‚Äî"}</div>
        <div class="clock">${clockTxt || ""}</div>
      </div>

      <div class="team right">
        <div>
          <div class="teamName">${H.name}</div>
          <div class="teamSub">${H.abbr || ""}</div>
        </div>
        <div class="teamLogo"><img src="${H.logo}" onerror="this.style.display='none'; this.parentNode.textContent='üè∑Ô∏è';"></div>
      </div>
    </div>

    <div class="eventFoot">
      <div>üïí ${when}</div>
      <div class="eventActions">
        <button class="btnMini primary" onclick="${action}">VER</button>
        <button class="btnMini ghost favBtn" onclick="toggleFav(\'${eventId}\')" title="Favorito">${FAVS.has(String(eventId)) ? "‚òÖ" : "‚òÜ"}</button>
      </div>
    </div>

    ${DEV_SHOW_EVENT_ID ? `<div class="eventId">eventId: ${eventId}</div>` : ``}
  </div>`;
}

async function loadEvents(){
  const leagueKey = $("#leagueSelect").value;
  const grid = $("#eventsGrid");
  const badge = $("#eventsBadge");
  const hint = $("#eventsHint");

  grid.innerHTML = renderEventSkeletons(4);
  badge.textContent = "Cargando‚Ä¶";
  hint.textContent = "";

  // Cargar links compartidos (Netlify o Gist)
  const linksOk = await loadEventLinks();

  try{
    const data = await fetchESPNScoreboard(leagueKey);
    const events = data?.events || [];
    const leagueInfo = leagueFromResponse(data, leagueKey);
    EVENTS_LEAGUE_INFO = leagueInfo;
    EVENTS_RAW = events;

    const nowTxt = new Date().toLocaleTimeString();
    if (EVENT_LINKS_UPDATED_AT) {
      hint.textContent = `Links: ${EVENT_LINKS_UPDATED_AT} ‚Ä¢ Actualizado: ${nowTxt}`;
    } else {
      hint.textContent = `Actualizado: ${nowTxt}${linksOk ? '' : ' ‚Ä¢ (sin links)'}`;
    }

    if(!events.length){
      badge.textContent = "0 eventos";
      grid.innerHTML = `<div class="eventId">No hay partidos hoy en esta liga.</div>`;
      return;
    }

    renderEvents();

  }catch(err){
    badge.textContent = "Error";
    grid.innerHTML = `<div class="eventId">No se pudo cargar ESPN.</div>`;
  }
}

$("#refreshEvents").addEventListener("click", loadEvents);
$("#leagueSelect").addEventListener("change", loadEvents);

// Filtros + b√∫squeda de eventos
function syncEventFilterUI(){
  $$("#eventFilters .chip").forEach(b=>b.classList.toggle("active", b.dataset.filter===EVENT_FILTER));
}
$("#eventFilters").addEventListener("click", (e)=>{
  const btn = e.target.closest(".chip");
  if(!btn) return;
  EVENT_FILTER = btn.dataset.filter || "all";
  syncEventFilterUI();
  renderEvents();
});
syncEventFilterUI();

let _evSearchT = null;
$("#eventSearch").addEventListener("input", (e)=>{
  clearTimeout(_evSearchT);
  _evSearchT = setTimeout(()=>{
    EVENT_SEARCH = e.target.value || "";
    renderEvents();
  }, 120);
});

// Auto-refresh (cada 90s)
const AUTO_KEY = "fluxoAutoRefresh";
const autoCb = $("#autoRefresh");
autoCb.checked = (localStorage.getItem(AUTO_KEY) === "1");
function applyAutoRefresh(){
  if(AUTO_TIMER){ clearInterval(AUTO_TIMER); AUTO_TIMER = null; }
  if(autoCb.checked){
    localStorage.setItem(AUTO_KEY, "1");
    AUTO_TIMER = setInterval(()=>{ if(!window.__fluxoModalOpen) loadEvents(); }, 90000);
  }else{
    localStorage.setItem(AUTO_KEY, "0");
  }
}
autoCb.addEventListener("change", applyAutoRefresh);
applyAutoRefresh();


/* =========================
   Modo cine
========================= */
let cine = true;
$("#modeBtn").addEventListener("click", ()=>{
  cine = !cine;
  $("#modeTxt").textContent = cine ? "Modo cine" : "Modo claro";
  document.body.style.filter = cine ? "none" : "brightness(1.08) contrast(1.02)";
});
</script>

</body>
</html>
